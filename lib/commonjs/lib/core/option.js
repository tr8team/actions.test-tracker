import { KResult } from "./result.js";
import { UnwrapError } from "./error.js";
class Opt {
    // takes in a list of options and returns a new option with a list of some values if all the results are some, and none if any are none
    /**
     * @template T
     * @param i - list of options
     */
    static all(...i) {
        const closure = async () => {
            const some = [];
            let none = 0;
            const r = i.map(async (e) => {
                const isSome = await e.isSome();
                if (isSome) {
                    const ok = await e.unwrap();
                    return ["some", ok];
                }
                else {
                    return ["none", null];
                }
            });
            const a = await Promise.all(r);
            for (const [t, v] of a) {
                if (t === "some") {
                    some.push(v);
                }
                else {
                    none++;
                }
            }
            if (none > 0) {
                return None();
            }
            return Some(some);
        };
        return Opt.fromAsync(closure());
    }
    // Resolve the promise of an option, Promise<Option<T>> to Option<T> without async/await
    /**
     * @template T
     * @param p - promise of an option to resolve
     * @returns {Option<T>} resolved option
     */
    static fromAsync(p) {
        return new KOption((async () => {
            const r = await p;
            const isSome = await r.isSome();
            if (isSome) {
                const ok = await r.unwrap();
                return Promise.resolve(["some", ok]);
            }
            return Promise.resolve(["none", null]);
        })());
    }
    // Create an Option from an async function
    /**
     * @template T
     * @param fn - async function that returns an option
     * @returns {Option<T>} option from the async function
     */
    static async(fn) {
        return Opt.fromAsync(fn());
    }
}
class KOption {
    constructor(value) {
        this.value = Promise.resolve(value);
    }
    value;
    async native() {
        const [, v] = await this.value;
        return v;
    }
    andThen(fn) {
        return new KOption((async () => {
            const [type, value] = await this.value;
            if (type === "none") {
                return [type, value];
            }
            else {
                const mapped = await fn(value);
                const isSome = await mapped.isSome();
                if (isSome) {
                    const v = mapped.unwrap();
                    return ["some", v];
                }
                else {
                    return ["none", null];
                }
            }
        })());
    }
    asErr(ok) {
        return new KResult((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                const s = await ok;
                return ["ok", s];
            }
            else {
                return ["err", v];
            }
        })());
    }
    asOk(err) {
        return new KResult((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                const s = await err;
                return ["err", s];
            }
            else {
                return ["ok", v];
            }
        })());
    }
    asResult(fn) {
        return new KResult(Promise.resolve(["ok", 0])).andThen(async () => {
            const [t, v] = await this.value;
            return await (async () => {
                if (t === "none") {
                    if (typeof fn.none === "function") {
                        const f = fn.none;
                        return Promise.resolve(f());
                    }
                    else {
                        return Promise.resolve(fn.none);
                    }
                }
                else {
                    return fn.some(v);
                }
            })();
        });
    }
    async isNone() {
        const [t] = await this.value;
        return t === "none";
    }
    async isSome() {
        const [t] = await this.value;
        return t === "some";
    }
    map(fn) {
        return new KOption((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                return [t, v];
            }
            else {
                const fv = await fn(v);
                return [t, fv];
            }
        })());
    }
    async match(fn) {
        const [t, v] = await this.value;
        if (t === "some") {
            return Promise.resolve(fn.some(v));
        }
        else {
            if (typeof fn.none === "function") {
                const f = fn.none;
                return Promise.resolve(f());
            }
            else {
                return Promise.resolve(fn.none);
            }
        }
    }
    run(sideEffect) {
        return new KOption((async () => {
            const [t, v] = await this.value;
            if (t === "none") {
                return [t, v];
            }
            else {
                await sideEffect(v);
                return [t, v];
            }
        })());
    }
    async unwrap() {
        const [t, v] = await this.value;
        if (t === "some") {
            return v;
        }
        else {
            throw new UnwrapError("Failed to unwrap", "option", "Expected Some got None");
        }
    }
    async unwrapOr(def) {
        const [t, v] = await this.value;
        if (t === "some") {
            return v;
        }
        else {
            if (typeof def === "function") {
                const f = def;
                return Promise.resolve(f());
            }
            else {
                return def;
            }
        }
    }
}
function Some(v) {
    return new KOption(Promise.resolve(["some", v]));
}
function None() {
    return new KOption(Promise.resolve(["none", null]));
}
export { KOption, Some, None, Opt };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL29wdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFVLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxZQUFZLENBQUM7QUEwQnpDLE1BQU0sR0FBRztJQUNQLHVJQUF1STtJQUN2STs7O09BR0c7SUFDSCxNQUFNLENBQUMsR0FBRyxDQUE4QixHQUFHLENBQVM7UUFDbEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxJQUFvQyxFQUFFO1lBQ3pELE1BQU0sSUFBSSxHQUFrQixFQUFtQixDQUFDO1lBQ2hELElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNiLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMxQixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDaEMsSUFBSSxNQUFNLEVBQUU7b0JBQ1YsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQzVCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3JCO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7aUJBQ3ZCO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0IsS0FBSyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLEtBQUssTUFBTSxFQUFFO29CQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNkO3FCQUFNO29CQUNM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QUFJLENBQUMsS0FBSyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNoQixPQUFPLENBQUMsQ0FBQztTQUNWO2FBQU07WUFDTCxJQUFJLE9BQU8sR0FBRyxLQUFLLFVBQVUsRUFBRTtnQkFDN0IsTUFBTSxDQUFDLEdBQUcsR0FBcUMsQ0FBQztnQkFDaEQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDN0I7aUJBQU07Z0JBQ0wsT0FBTyxHQUFHLENBQUM7YUFDWjtTQUNGO0lBQ0gsQ0FBQztDQUNGO0FBRUQsU0FBUyxJQUFJLENBQUksQ0FBSTtJQUNuQixPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25ELENBQUM7QUFFRCxTQUFTLElBQUk7SUFDWCxPQUFPLElBQUksT0FBTyxDQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFFRCxPQUFPLEVBQVUsT0FBTyxFQUFzQixJQUFJLEVBQUUsSUFBSSxFQUFnQixHQUFHLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtSZXN1bHQsIFJlc3VsdCB9IGZyb20gXCIuL3Jlc3VsdC5qc1wiO1xuaW1wb3J0IHsgVW53cmFwRXJyb3IgfSBmcm9tIFwiLi9lcnJvci5qc1wiO1xuXG5pbnRlcmZhY2UgTWF0Y2g8VCwgVT4ge1xuICAvLyBNYXAgdGhlIFNvbWUgdmFsdWUgdG8gYSBzdGFuZGFyZCB0eXBlXG4gIHNvbWU6ICgodmFsOiBUKSA9PiBVKSB8ICgodmFsOiBUKSA9PiBQcm9taXNlPFU+KTtcbiAgLy8gTWFwIHRoZSBOb25lIHZhbHVlIHRvIGEgc3RhbmRhcmQgdHlwZVxuICBub25lOiAoKCkgPT4gVSkgfCAoKCkgPT4gUHJvbWlzZTxVPikgfCBVIHwgUHJvbWlzZTxVPjtcbn1cblxuaW50ZXJmYWNlIFJlc3VsdE1hdGNoPFQsIFUsIEU+IHtcbiAgc29tZTogKCh2YWw6IFQpID0+IFJlc3VsdDxVLCBFPikgfCAoKHZhbDogVCkgPT4gUHJvbWlzZTxSZXN1bHQ8VSwgRT4+KTtcbiAgbm9uZTpcbiAgICB8ICgoKSA9PiBSZXN1bHQ8VSwgRT4pXG4gICAgfCAoKCkgPT4gUHJvbWlzZTxSZXN1bHQ8VSwgRT4+KVxuICAgIHwgUmVzdWx0PFUsIEU+XG4gICAgfCBQcm9taXNlPFJlc3VsdDxVLCBFPj47XG59XG5cbnR5cGUgT3B0aW9uU29tZTxUIGV4dGVuZHMgT3B0aW9uPHVua25vd24+W10+ID0ge1xuICBbSyBpbiBrZXlvZiBUXTogSyBleHRlbmRzIG51bWJlclxuICAgID8gVFtLXSBleHRlbmRzIE9wdGlvbjxpbmZlciBVPlxuICAgICAgPyBVXG4gICAgICA6IG5ldmVyXG4gICAgOiBuZXZlcjtcbn07XG5cbmNsYXNzIE9wdCB7XG4gIC8vIHRha2VzIGluIGEgbGlzdCBvZiBvcHRpb25zIGFuZCByZXR1cm5zIGEgbmV3IG9wdGlvbiB3aXRoIGEgbGlzdCBvZiBzb21lIHZhbHVlcyBpZiBhbGwgdGhlIHJlc3VsdHMgYXJlIHNvbWUsIGFuZCBub25lIGlmIGFueSBhcmUgbm9uZVxuICAvKipcbiAgICogQHRlbXBsYXRlIFRcbiAgICogQHBhcmFtIGkgLSBsaXN0IG9mIG9wdGlvbnNcbiAgICovXG4gIHN0YXRpYyBhbGw8VCBleHRlbmRzIE9wdGlvbjx1bmtub3duPltdPiguLi5pOiBbLi4uVF0pOiBPcHRpb248T3B0aW9uU29tZTxUPj4ge1xuICAgIGNvbnN0IGNsb3N1cmUgPSBhc3luYyAoKTogUHJvbWlzZTxPcHRpb248T3B0aW9uU29tZTxUPj4+ID0+IHtcbiAgICAgIGNvbnN0IHNvbWU6IE9wdGlvblNvbWU8VD4gPSBbXSBhcyBPcHRpb25Tb21lPFQ+O1xuICAgICAgbGV0IG5vbmUgPSAwO1xuICAgICAgY29uc3QgciA9IGkubWFwKGFzeW5jIChlKSA9PiB7XG4gICAgICAgIGNvbnN0IGlzU29tZSA9IGF3YWl0IGUuaXNTb21lKCk7XG4gICAgICAgIGlmIChpc1NvbWUpIHtcbiAgICAgICAgICBjb25zdCBvayA9IGF3YWl0IGUudW53cmFwKCk7XG4gICAgICAgICAgcmV0dXJuIFtcInNvbWVcIiwgb2tdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBbXCJub25lXCIsIG51bGxdO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGEgPSBhd2FpdCBQcm9taXNlLmFsbChyKTtcbiAgICAgIGZvciAoY29uc3QgW3QsIHZdIG9mIGEpIHtcbiAgICAgICAgaWYgKHQgPT09IFwic29tZVwiKSB7XG4gICAgICAgICAgc29tZS5wdXNoKHYpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5vbmUrKztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobm9uZSA+IDApIHtcbiAgICAgICAgcmV0dXJuIE5vbmU8T3B0aW9uU29tZTxUPj4oKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBTb21lKHNvbWUpO1xuICAgIH07XG4gICAgcmV0dXJuIE9wdC5mcm9tQXN5bmMoY2xvc3VyZSgpKTtcbiAgfVxuXG4gIC8vIFJlc29sdmUgdGhlIHByb21pc2Ugb2YgYW4gb3B0aW9uLCBQcm9taXNlPE9wdGlvbjxUPj4gdG8gT3B0aW9uPFQ+IHdpdGhvdXQgYXN5bmMvYXdhaXRcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSBwIC0gcHJvbWlzZSBvZiBhbiBvcHRpb24gdG8gcmVzb2x2ZVxuICAgKiBAcmV0dXJucyB7T3B0aW9uPFQ+fSByZXNvbHZlZCBvcHRpb25cbiAgICovXG4gIHN0YXRpYyBmcm9tQXN5bmM8VD4ocDogUHJvbWlzZTxPcHRpb248VD4+KTogT3B0aW9uPFQ+IHtcbiAgICByZXR1cm4gbmV3IEtPcHRpb248VD4oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByID0gYXdhaXQgcDtcbiAgICAgICAgY29uc3QgaXNTb21lID0gYXdhaXQgci5pc1NvbWUoKTtcbiAgICAgICAgaWYgKGlzU29tZSkge1xuICAgICAgICAgIGNvbnN0IG9rID0gYXdhaXQgci51bndyYXAoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtcInNvbWVcIiwgb2tdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtcIm5vbmVcIiwgbnVsbF0pO1xuICAgICAgfSkoKVxuICAgICk7XG4gIH1cblxuICAvLyBDcmVhdGUgYW4gT3B0aW9uIGZyb20gYW4gYXN5bmMgZnVuY3Rpb25cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSBmbiAtIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhbiBvcHRpb25cbiAgICogQHJldHVybnMge09wdGlvbjxUPn0gb3B0aW9uIGZyb20gdGhlIGFzeW5jIGZ1bmN0aW9uXG4gICAqL1xuICBzdGF0aWMgYXN5bmM8VD4oZm46ICgpID0+IFByb21pc2U8T3B0aW9uPFQ+Pik6IE9wdGlvbjxUPiB7XG4gICAgcmV0dXJuIE9wdC5mcm9tQXN5bmMoZm4oKSk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIE9wdGlvbjxUPiB7XG4gIC8vIENoZWNrcyBpZiB0aGUgT3B0aW9uIGlzIFNvbWVcbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBpZiB0aGUgb3B0aW9uIGlzIFNvbWVcbiAgICovXG4gIGlzU29tZSgpOiBQcm9taXNlPGJvb2xlYW4+O1xuXG4gIC8vIENoZWNrcyBpZiB0aGUgT3B0aW9uIGlzIE5vbmVcbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBpZiB0aGUgb3B0aW9uIGlzIE5vbmVcbiAgICovXG4gIGlzTm9uZSgpOiBQcm9taXNlPGJvb2xlYW4+O1xuXG4gIC8vIFBhdHRlcm4gTWF0Y2ggYW5kIHJldHVybiBhIHN0YW5kYXJkIHZhbHVlIGJ5IHByb3ZpZGluZyBtYXBwZXIgZnVuY3Rpb25zIGZvclxuICAvLyBTb21lIG9yIE5vbmVcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBULCBVXG4gICAqIEBwYXJhbSBmbiAtIHNvbWUgbWFwcGVyIGZ1bmN0aW9uIGFuZCBub25lIG1hcHBlciBmdW5jdGlvbi4gQm90aCBtYXBwZXJzIGNhblxuICAgKiBiZSBib3RoIHN5bmMgb3IgYXN5bmNcbiAgICogQHJldHVybnMge1Byb21pc2U8VT59IHRoZSBzdGFuZGFyZCB2YWx1ZSB0aGF0IGJvdGggbWFwcGVyIG1hcHMgdG9cbiAgICovXG4gIG1hdGNoPFU+KGZuOiBNYXRjaDxULCBVPik6IFByb21pc2U8VT47XG5cbiAgLy8gTWFwcyB0aGUgdW5kZXJseWluZyB2YWx1ZSB0byBhbm90aGVyIHZhbHVlLCBpZiBpdCBpcyBub3QgTm9uZVxuICAvLyBNYXBwZXIgZnVuY3Rpb24gY2FuIGJlIGFzeW5jIG9yIHN5bmMuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVCwgVVxuICAgKiBAcGFyYW0gZm4gLSBtYXBwZXIgZnVuY3Rpb24gdG8gbWFwIHRoZSB1bmRlcmx5aW5nIHZhbHVlLiBDYW4gYmUgc3luYyBvciBhc3luY1xuICAgKiBAcmV0dXJucyB7T3B0aW9uPFU+fSBNYXBwZWQgT3B0aW9uXG4gICAqL1xuICBtYXA8VT4oZm46ICgodmFsOiBUKSA9PiBVKSB8ICgodmFsOiBUKSA9PiBQcm9taXNlPFU+KSk6IE9wdGlvbjxVPjtcblxuICAvLyBFeGVjdXRlIHRoZSBtYXBwZXIgZnVuY3Rpb24gaWYgaXQgaXMgbm90IE5vbmUgYW5kIHRoZSBtYXBwZXIgcmV0dXJucyBhbiBPcHRpb24uXG4gIC8vIE1hcHBlciBmdW5jdGlvbiBjYW4gYmUgYXN5bmMgb3Igc3luYy5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBULFVcbiAgICogQHBhcmFtIGZuIC0gbWFwcGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBvbiBPcHRpb24uIENhbiBiZSBhc3luYyBvciBzeW5jLlxuICAgKiBAcmV0dXJucyB7T3B0aW9uPFU+fSBNYXBwZWQgT3B0aW9uXG4gICAqL1xuICBhbmRUaGVuPFU+KFxuICAgIGZuOiAoKHY6IFQpID0+IE9wdGlvbjxVPikgfCAoKHY6IFQpID0+IFByb21pc2U8T3B0aW9uPFU+PilcbiAgKTogT3B0aW9uPFU+O1xuXG4gIC8vIFJlbW92ZXMgdGhlIE9wdGlvbiB0eXBlIGFuZCByZXR1cm4gdGhlIHVuZGVybHlpbmcgdmFsdWUuXG4gIC8vIFRocm93cyBhbiBlcnJvciBpZiBOb25lIHdhcyBpbnNpZGUuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVFxuICAgKiBAdGhyb3dzIHtVbndyYXBFcnJvcn0gSW4gdGhlIGV2ZW50IHRoYXQgaXQgd2FzIGF0dGVtcHRpbmcgdG8gdW53cmFwIE5vbmVcbiAgICogQHJldHVybiB7UHJvbWlzZTxUPn0gVGhlIHVuZGVybHlpbmcgdmFsdWVcbiAgICovXG4gIHVud3JhcCgpOiBQcm9taXNlPFQ+O1xuXG4gIC8vIFJlbW92ZXMgdGhlIE9wdGlvbiB0eXBlIGFuZCByZXR1cm4gdGhlIHVuZGVybHlpbmcgdmFsdWUsIGJ1dCBpZiBpdCByZXNvbHZlcyB0b1xuICAvLyBOb25lLCBoYW5kbGUgaXQgYnkgY2hlY2tpbmcgdGhlIGFyZ3VtZW50IHBhc3NlZCBpbi5cbiAgLy8gQXJndW1lbnQgY2FuIGJlIGEgZGVmZXJyZWQgKGZ1bmN0aW9uKSBvciBpbW1lZGlhdGUgdmFsdWUsIGFuZCBjYW4gYmUgc3luY1xuICAvLyBvciBhc3luYy5cbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSBkZWYgLSB0aGUgdmFsdWUgdG8gcmV0dXJuIGluIGNhc2Ugb3B0aW9uIHJldHVybnMgdG8gbm9uZS4gSXQgY2FuIGJlIGltbWVkYXRlXG4gICAqIHZhbHVlIChsaXRlcmFsKSBvciBpdCBjYW4gYmUgZGVmZXJyZWQgKGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBUKS4gQm90aCBjYW4gYmUgc3luYyBvclxuICAgKiBhc3luY1xuICAgKiBAcmV0dXJuIHtQcm9taXNlPFQ+fSBUaGUgdW5kZXJseWluZyB2YWx1ZVxuICAgKi9cbiAgdW53cmFwT3IoZGVmOiBUIHwgUHJvbWlzZTxUPiB8ICgoKSA9PiBUKSB8ICgoKSA9PiBQcm9taXNlPFQ+KSk6IFByb21pc2U8VD47XG5cbiAgLy8gQ29udmVydHMgYW4gb3B0aW9uIGludG8gYW4gRXJyIFJlc3VsdC4gVXNlciBuZWVkcyB0byBwcm92aWRlIHRoZSBPa1xuICAvLyBSZXN1bHQgaW4gY2FzZSB0aGUgb3B0aW9uIHJlc29sdmVzIHRvIE5vbmVcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBPLCBUXG4gICAqIEBwYXJhbSB7TyB8IFByb21pc2U8Tz59IG9rIC0gT2sgdmFsdWUgaW4gdGhlIGV2ZW50IE9wdGlvbiByZXNvbHZlcyB0byBOb25lXG4gICAqIEByZXR1cm4ge1Jlc3VsdDxULEU+fSAtIFRoZSBvcHRpb24gdmFsdWUgYXMgZXJyIHJlc3VsdFxuICAgKi9cbiAgYXNFcnI8Tz4ob2s6IE8gfCBQcm9taXNlPE8+KTogUmVzdWx0PE8sIFQ+O1xuXG4gIC8vIENvbnZlcnRzIGFuIG9wdGlvbiBpbnRvIGFuIE9rIFJlc3VsdC4gVXNlciBuZWVkcyB0byBwcm92aWRlIHRoZSBFcnJcbiAgLy8gUmVzdWx0IGluIGNhc2UgdGhlIG9wdGlvbiByZXNvbHZlcyB0byBOb25lXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgRSwgVFxuICAgKiBAcGFyYW0ge0UgfCBQcm9taXNlPEU+fSBlcnIgLSBFcnJvciB2YWx1ZSBpbiB0aGUgZXZlbnQgT3B0aW9uIHJlc29sdmVzIHRvIE5vbmVcbiAgICogQHJldHVybiB7UmVzdWx0PFQsRT59IC0gVGhlIG9wdGlvbiB2YWx1ZSBhcyBvayByZXN1bHRcbiAgICovXG4gIGFzT2s8RT4oZXJyOiBFIHwgUHJvbWlzZTxFPik6IFJlc3VsdDxULCBFPjtcblxuICAvLyBDb252ZXJ0cyBhbiBvcHRpb24gdG8gYSByZXN1bHQsIGJ5IG1hcHBpbmcgYm90aCBOb25lIGFuZCBTb21lIHRvIGFcbiAgLy8gc3RhbmRhcmQgcmVzdWx0IHR5cGUuXG4gIC8qKlxuICAgKiBAdGVtcGxhdGUgVCwgTywgRVxuICAgKiBAcGFyYW0gZm4gLSB0aGUgbWFwcGVyIGZ1bmN0aW9ucyBmb3IgU29tZSBhbmQgTm9uZS4gQWxsIG1hcHBlciBmdW5jdGlvbnNcbiAgICogY2FuIGJlIHN5bmMgb3IgYXN5bmMuIEFkZGl0aW9uYWxseSwgTm9uZSBhY2NlcHRzIGxpdGVyYWwgdmFsdWVzIGluc3RlYWRcbiAgICogb3IgbWFwcGVyc1xuICAgKiBAcmV0dXJucyB7UmVzdWx0PE8sRT59IFJlc3VsdCBkZXJpdmVkIGZyb20gdGhlIE9wdGlvblxuICAgKi9cbiAgYXNSZXN1bHQ8TywgRT4oZm46IFJlc3VsdE1hdGNoPFQsIE8sIEU+KTogUmVzdWx0PE8sIEU+O1xuXG4gIC8vIFJ1bnMgdGhlIGZ1bmN0aW9uIHBhc3NlZCBpbiBidXQgZG9lcyBub3QgY2FwdHVyZSB0aGUgcmV0dXJuIHZhbHVlLlxuICAvLyBBY2NlcHRzIGJvdGggc3luYyBhbmQgYXN5bmMgZnVuY3Rpb25zLlxuICAvLyAqKkRvZXMgbm90IGhhbmRsZSBleGNlcHRpb25zKipcbiAgLyoqXG4gICAqIEB0ZW1wbGF0ZSBUXG4gICAqIEBwYXJhbSBzaWRlRWZmZWN0IC0gU2lkZSBlZmZlY3QgdG8gZXhlY3V0ZS4gQ2FuIGJlIHN5bmMgb3IgYXN5bmNcbiAgICogQHJldHVybnMge09wdGlvbjxUPn0gT3JpZ2luYWwgT3B0aW9uXG4gICAqL1xuICBydW4oc2lkZUVmZmVjdDogKCh0OiBUKSA9PiB2b2lkKSB8ICgodDogVCkgPT4gUHJvbWlzZTx2b2lkPikpOiBPcHRpb248VD47XG5cbiAgLy8gT2J0YWluIHRoZSB1bmRlcmx5aW5nIHZhbHVlIG9yIG5hdGl2ZSwgd2hpY2ggaXMgdGhlIG5hdGl2ZSB2ZXJzaW9uIG9mIE9wdGlvblxuICBuYXRpdmUoKTogUHJvbWlzZTxUIHwgbnVsbD47XG59XG5cbnR5cGUgSVNvbWU8VD4gPSBbXCJzb21lXCIsIFRdO1xudHlwZSBJTm9uZSA9IFtcIm5vbmVcIiwgbnVsbF07XG5cbmNsYXNzIEtPcHRpb248VD4gaW1wbGVtZW50cyBPcHRpb248VD4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICB2YWx1ZTogUHJvbWlzZTxJU29tZTxUPj4gfCBQcm9taXNlPElOb25lPiB8IFByb21pc2U8SVNvbWU8VD4gfCBJTm9uZT5cbiAgKSB7XG4gICAgdGhpcy52YWx1ZSA9IFByb21pc2UucmVzb2x2ZSh2YWx1ZSk7XG4gIH1cblxuICB2YWx1ZTogUHJvbWlzZTxJU29tZTxUPiB8IElOb25lPjtcblxuICBhc3luYyBuYXRpdmUoKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuICAgIGNvbnN0IFssIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICByZXR1cm4gdjtcbiAgfVxuXG4gIGFuZFRoZW48VT4oXG4gICAgZm46ICgodjogVCkgPT4gT3B0aW9uPFU+KSB8ICgodjogVCkgPT4gUHJvbWlzZTxPcHRpb248VT4+KVxuICApOiBPcHRpb248VT4ge1xuICAgIHJldHVybiBuZXcgS09wdGlvbjxVPihcbiAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IFt0eXBlLCB2YWx1ZV0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodHlwZSA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICByZXR1cm4gW3R5cGUsIHZhbHVlXSBhcyBJTm9uZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBtYXBwZWQgPSBhd2FpdCBmbih2YWx1ZSk7XG4gICAgICAgICAgY29uc3QgaXNTb21lID0gYXdhaXQgbWFwcGVkLmlzU29tZSgpO1xuICAgICAgICAgIGlmIChpc1NvbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHYgPSBtYXBwZWQudW53cmFwKCk7XG4gICAgICAgICAgICByZXR1cm4gW1wic29tZVwiLCB2XSBhcyBJU29tZTxVPjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFtcIm5vbmVcIiwgbnVsbF0gYXMgSU5vbmU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzRXJyPE8+KG9rOiBQcm9taXNlPE8+IHwgTyk6IFJlc3VsdDxPLCBUPiB7XG4gICAgcmV0dXJuIG5ldyBLUmVzdWx0PE8sIFQ+KFxuICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICAgICAgaWYgKHQgPT09IFwibm9uZVwiKSB7XG4gICAgICAgICAgY29uc3QgcyA9IGF3YWl0IG9rO1xuICAgICAgICAgIHJldHVybiBbXCJva1wiLCBzXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gW1wiZXJyXCIsIHZdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzT2s8RT4oZXJyOiBQcm9taXNlPEU+IHwgRSk6IFJlc3VsdDxULCBFPiB7XG4gICAgcmV0dXJuIG5ldyBLUmVzdWx0PFQsIEU+KFxuICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICAgICAgaWYgKHQgPT09IFwibm9uZVwiKSB7XG4gICAgICAgICAgY29uc3QgcyA9IGF3YWl0IGVycjtcbiAgICAgICAgICByZXR1cm4gW1wiZXJyXCIsIHNdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBbXCJva1wiLCB2XTtcbiAgICAgICAgfVxuICAgICAgfSkoKVxuICAgICk7XG4gIH1cblxuICBhc1Jlc3VsdDxPLCBFPihmbjogUmVzdWx0TWF0Y2g8VCwgTywgRT4pOiBSZXN1bHQ8TywgRT4ge1xuICAgIHJldHVybiBuZXcgS1Jlc3VsdDxudW1iZXIsIEU+KFByb21pc2UucmVzb2x2ZShbXCJva1wiLCAwXSkpLmFuZFRoZW4oXG4gICAgICBhc3luYyAoKTogUHJvbWlzZTxSZXN1bHQ8TywgRT4+ID0+IHtcbiAgICAgICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgaWYgKHQgPT09IFwibm9uZVwiKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZuLm5vbmUgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICBjb25zdCBmID0gZm4ubm9uZTtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmKCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmbi5ub25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZuLnNvbWUodik7XG4gICAgICAgICAgfVxuICAgICAgICB9KSgpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBhc3luYyBpc05vbmUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgW3RdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICByZXR1cm4gdCA9PT0gXCJub25lXCI7XG4gIH1cblxuICBhc3luYyBpc1NvbWUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgW3RdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICByZXR1cm4gdCA9PT0gXCJzb21lXCI7XG4gIH1cblxuICBtYXA8VT4oZm46ICgodmFsOiBUKSA9PiBVKSB8ICgodmFsOiBUKSA9PiBQcm9taXNlPFU+KSk6IE9wdGlvbjxVPiB7XG4gICAgcmV0dXJuIG5ldyBLT3B0aW9uPFU+KFxuICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICAgICAgaWYgKHQgPT09IFwibm9uZVwiKSB7XG4gICAgICAgICAgcmV0dXJuIFt0LCB2XTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBmdiA9IGF3YWl0IGZuKHYpO1xuICAgICAgICAgIHJldHVybiBbdCwgZnZdO1xuICAgICAgICB9XG4gICAgICB9KSgpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIG1hdGNoPFU+KGZuOiBNYXRjaDxULCBVPik6IFByb21pc2U8VT4ge1xuICAgIGNvbnN0IFt0LCB2XSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgaWYgKHQgPT09IFwic29tZVwiKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZuLnNvbWUodikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGZuLm5vbmUgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjb25zdCBmID0gZm4ubm9uZSBhcyAoKCkgPT4gVSkgfCAoKCkgPT4gUHJvbWlzZTxVPik7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZigpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm4ubm9uZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcnVuKHNpZGVFZmZlY3Q6ICgodDogVCkgPT4gdm9pZCkgfCAoKHQ6IFQpID0+IFByb21pc2U8dm9pZD4pKTogT3B0aW9uPFQ+IHtcbiAgICByZXR1cm4gbmV3IEtPcHRpb24oXG4gICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbdCwgdl0gPSBhd2FpdCB0aGlzLnZhbHVlO1xuICAgICAgICBpZiAodCA9PT0gXCJub25lXCIpIHtcbiAgICAgICAgICByZXR1cm4gW3QsIHZdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IHNpZGVFZmZlY3Qodik7XG4gICAgICAgICAgcmV0dXJuIFt0LCB2XTtcbiAgICAgICAgfVxuICAgICAgfSkoKVxuICAgICk7XG4gIH1cblxuICBhc3luYyB1bndyYXAoKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgW3QsIHZdID0gYXdhaXQgdGhpcy52YWx1ZTtcbiAgICBpZiAodCA9PT0gXCJzb21lXCIpIHtcbiAgICAgIHJldHVybiB2O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgVW53cmFwRXJyb3IoXG4gICAgICAgIFwiRmFpbGVkIHRvIHVud3JhcFwiLFxuICAgICAgICBcIm9wdGlvblwiLFxuICAgICAgICBcIkV4cGVjdGVkIFNvbWUgZ290IE5vbmVcIlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1bndyYXBPcihcbiAgICBkZWY6IFByb21pc2U8VD4gfCAoKCkgPT4gVCkgfCAoKCkgPT4gUHJvbWlzZTxUPikgfCBUXG4gICk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IFt0LCB2XSA9IGF3YWl0IHRoaXMudmFsdWU7XG4gICAgaWYgKHQgPT09IFwic29tZVwiKSB7XG4gICAgICByZXR1cm4gdjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiBkZWYgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjb25zdCBmID0gZGVmIGFzICgoKSA9PiBUKSB8ICgoKSA9PiBQcm9taXNlPFQ+KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmKCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGRlZjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gU29tZTxUPih2OiBUKTogT3B0aW9uPFQ+IHtcbiAgcmV0dXJuIG5ldyBLT3B0aW9uKFByb21pc2UucmVzb2x2ZShbXCJzb21lXCIsIHZdKSk7XG59XG5cbmZ1bmN0aW9uIE5vbmU8VD4oKTogT3B0aW9uPFQ+IHtcbiAgcmV0dXJuIG5ldyBLT3B0aW9uPFQ+KFByb21pc2UucmVzb2x2ZShbXCJub25lXCIsIG51bGxdKSk7XG59XG5cbmV4cG9ydCB7IE9wdGlvbiwgS09wdGlvbiwgTWF0Y2gsIFJlc3VsdE1hdGNoLCBTb21lLCBOb25lLCBJU29tZSwgSU5vbmUsIE9wdCB9O1xuIl19